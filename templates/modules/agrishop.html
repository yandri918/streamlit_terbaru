<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriShop - Marketplace Hasil Panen | AgriSensa</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 1.1rem;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #2d3748;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #cbd5e0;
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
        }

        /* Sidebar Filters */
        .sidebar {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .sidebar h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .filter-group {
            margin-bottom: 25px;
        }

        .filter-group label {
            display: block;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .filter-group select,
        .filter-group input[type="number"],
        .filter-group input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Product Grid */
        .products-section {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .products-header h2 {
            color: #2d3748;
            font-size: 1.8rem;
        }

        .product-count {
            color: #718096;
            font-size: 1rem;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        /* Product Card */
        .product-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .product-image {
            width: 100%;
            height: 180px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: white;
        }

        .product-info {
            padding: 20px;
        }

        .product-badges {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-quality-a {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge-quality-b {
            background: #bee3f8;
            color: #2c5282;
        }

        .badge-quality-c {
            background: #fed7d7;
            color: #742a2a;
        }

        .badge-preorder {
            background: #feebc8;
            color: #7c2d12;
        }

        .product-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }

        .product-price {
            font-size: 1.5rem;
            font-weight: 800;
            color: #667eea;
            margin-bottom: 8px;
        }

        .product-quantity {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 12px;
        }

        .product-location {
            color: #4a5568;
            font-size: 0.85rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .product-seller {
            color: #718096;
            font-size: 0.85rem;
            margin-bottom: 15px;
        }

        .product-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.85rem;
            flex: 1;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-header h2 {
            color: #2d3748;
            font-size: 1.8rem;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 2rem;
            color: #718096;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: #2d3748;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .price-recommendation {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .price-recommendation h4 {
            color: #2d3748;
            margin-bottom: 10px;
        }

        .price-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .price-info strong {
            color: #667eea;
            font-size: 1.2rem;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
        }

        .toast {
            background: white;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: toastSlideIn 0.3s ease-out;
        }

        @keyframes toastSlideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast-success {
            border-left: 4px solid #48bb78;
        }

        .toast-error {
            border-left: 4px solid #f56565;
        }

        .toast-info {
            border-left: 4px solid #4299e1;
        }

        .toast-icon {
            font-size: 1.5rem;
        }

        .toast-message {
            flex: 1;
            color: #2d3748;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2rem;
        }

        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state-icon {
            font-size: 5rem;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #2d3748;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: static;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .products-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .header-actions {
                flex-direction: column;
            }

            .header-actions .btn {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üõí AgriShop - Marketplace Hasil Panen</h1>
            <p>Jual beli hasil panen langsung dari petani ke pembeli</p>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="showAddProductModal()">
                    <i class="fas fa-plus"></i> Jual Produk Saya
                </button>
                <button class="btn btn-secondary" onclick="showSellerDashboard()">
                    <i class="fas fa-chart-line"></i> Dashboard Penjual
                </button>
                <a href="/" class="btn btn-secondary">
                    <i class="fas fa-home"></i> Kembali ke Beranda
                </a>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Sidebar Filters -->
            <div class="sidebar">
                <h3><i class="fas fa-filter"></i> Filter Produk</h3>

                <div class="filter-group">
                    <label>Jenis Komoditas</label>
                    <select id="filter-commodity" onchange="applyFilters()">
                        <option value="">Semua Komoditas</option>
                        <option value="padi">Padi</option>
                        <option value="jagung">Jagung</option>
                        <option value="cabe_merah_keriting">Cabe Merah Keriting</option>
                        <option value="cabe_merah_besar">Cabe Merah Besar</option>
                        <option value="cabe_rawit_hijau">Cabe Rawit Hijau</option>
                        <option value="cabe_rawit_merah">Cabe Rawit Merah</option>
                        <option value="cabe_hijau_besar">Cabe Hijau Besar</option>
                        <option value="cabe_keriting_hijau">Cabe Keriting Hijau</option>
                        <option value="tomat">Tomat</option>
                        <option value="kentang">Kentang</option>
                        <option value="bawang">Bawang Merah</option>
                        <option value="kedelai">Kedelai</option>
                        <option value="kacang">Kacang Tanah</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Kualitas</label>
                    <select id="filter-quality" onchange="applyFilters()">
                        <option value="">Semua Kualitas</option>
                        <option value="A">Grade A (Premium)</option>
                        <option value="B">Grade B (Standar)</option>
                        <option value="C">Grade C (Ekonomis)</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>Harga Minimum (Rp/kg)</label>
                    <input type="number" id="filter-min-price" placeholder="0" onchange="applyFilters()">
                </div>

                <div class="filter-group">
                    <label>Harga Maksimum (Rp/kg)</label>
                    <input type="number" id="filter-max-price" placeholder="999999" onchange="applyFilters()">
                </div>

                <div class="filter-group">
                    <label>
                        <input type="checkbox" id="filter-preorder" onchange="applyFilters()">
                        Hanya Pre-Order
                    </label>
                </div>

                <button class="btn btn-secondary" style="width: 100%; margin-top: 15px;" onclick="resetFilters()">
                    <i class="fas fa-redo"></i> Reset Filter
                </button>
            </div>

            <!-- Products Section -->
            <div class="products-section">
                <div class="products-header">
                    <h2>Produk Tersedia</h2>
                    <span class="product-count" id="product-count">Loading...</span>
                </div>

                <div id="products-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        Memuat produk...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="add-product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-plus-circle"></i> Tambah Produk Baru</h2>
                <button class="close-modal" onclick="closeModal('add-product-modal')">&times;</button>
            </div>

            <form id="add-product-form" onsubmit="submitProduct(event)">
                <div class="form-group">
                    <label>Nama Penjual *</label>
                    <input type="text" id="seller-name" required>
                </div>

                <div class="form-group">
                    <label>Nomor WhatsApp *</label>
                    <input type="tel" id="seller-phone" placeholder="08xxxxxxxxxx" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Komoditas *</label>
                        <select id="commodity" required onchange="getPriceRecommendation()">
                            <option value="">Pilih Komoditas</option>
                            <option value="padi">Padi</option>
                            <option value="jagung">Jagung</option>
                            <option value="cabe_merah_keriting">Cabe Merah Keriting</option>
                            <option value="cabe_merah_besar">Cabe Merah Besar</option>
                            <option value="cabe_rawit_hijau">Cabe Rawit Hijau</option>
                        <option value="cabe_rawit_merah">Cabe Rawit Merah</option>
                            <option value="cabe_hijau_besar">Cabe Hijau Besar</option>
                            <option value="cabe_keriting_hijau">Cabe Keriting Hijau</option>
                            <option value="tomat">Tomat</option>
                            <option value="kentang">Kentang</option>
                            <option value="bawang">Bawang Merah</option>
                            <option value="kedelai">Kedelai</option>
                            <option value="kacang">Kacang Tanah</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Kualitas *</label>
                        <select id="quality-grade" required onchange="getPriceRecommendation()">
                            <option value="">Pilih Kualitas</option>
                            <option value="A">Grade A (Premium)</option>
                            <option value="B">Grade B (Standar)</option>
                            <option value="C">Grade C (Ekonomis)</option>
                        </select>
                    </div>
                </div>

                <div id="price-recommendation-box"></div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Jumlah (kg) *</label>
                        <input type="number" id="quantity-kg" step="0.1" min="0.1" required>
                    </div>

                    <div class="form-group">
                        <label>Harga per kg (Rp) *</label>
                        <input type="number" id="price-per-kg" step="100" min="100" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Alamat Lokasi *</label>
                    <input type="text" id="address" placeholder="Contoh: Desa Sukamaju, Kec. Cianjur" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Latitude (opsional)</label>
                        <input type="number" id="latitude" step="any" placeholder="-6.xxx">
                    </div>

                    <div class="form-group">
                        <label>Longitude (opsional)</label>
                        <input type="number" id="longitude" step="any" placeholder="106.xxx">
                    </div>
                </div>

                <div class="form-group">
                    <label>Tanggal Panen (opsional)</label>
                    <input type="date" id="harvest-date">
                </div>

                <div class="form-group">
                    <label>Deskripsi (opsional)</label>
                    <textarea id="description" placeholder="Deskripsikan kondisi produk Anda..."></textarea>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="is-preorder">
                        Tersedia untuk Pre-Order (diskon 5%)
                    </label>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-check"></i> Tambahkan Produk
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('add-product-modal')">
                        <i class="fas fa-times"></i> Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Product Detail Modal -->
    <div id="product-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-info-circle"></i> Detail Produk</h2>
                <button class="close-modal" onclick="closeModal('product-detail-modal')">&times;</button>
            </div>
            <div id="product-detail-content"></div>
        </div>
    </div>

    <!-- Seller Dashboard Modal -->
    <div id="seller-dashboard-modal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2><i class="fas fa-chart-line"></i> Dashboard Penjual</h2>
                <button class="close-modal" onclick="closeModal('seller-dashboard-modal')">&times;</button>
            </div>
            <div id="seller-dashboard-content">
                <div class="form-group">
                    <label>Nomor WhatsApp Anda</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="tel" id="dashboard-phone" placeholder="08xxxxxxxxxx" style="flex: 1;">
                        <button class="btn btn-primary" onclick="loadSellerDashboard()">
                            <i class="fas fa-search"></i> Lihat Dashboard
                        </button>
                    </div>
                </div>
                <div id="dashboard-data"></div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script>
        let allProducts = [];
        let currentProduct = null;

        // Load products on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
            loadSellerInfoFromStorage();
        });

        // ========== PRODUCT LOADING ==========

        async function loadProducts() {
            try {
                const response = await fetch('/api/agrishop/products');
                const result = await response.json();

                if (result.success) {
                    allProducts = result.data;
                    displayProducts(allProducts);
                } else {
                    showError('Gagal memuat produk');
                }
            } catch (error) {
                console.error('Error loading products:', error);
                showError('Terjadi kesalahan saat memuat produk');
            }
        }

        function displayProducts(products) {
            const container = document.getElementById('products-container');
            const countEl = document.getElementById('product-count');

            countEl.textContent = `${products.length} produk ditemukan`;

            if (products.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <h3>Belum Ada Produk</h3>
                        <p>Belum ada produk yang tersedia saat ini</p>
                        <button class="btn btn-primary" onclick="showAddProductModal()" style="margin-top: 20px;">
                            <i class="fas fa-plus"></i> Tambah Produk Pertama
                        </button>
                    </div>
                `;
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'products-grid';

            products.forEach(product => {
                const card = createProductCard(product);
                grid.appendChild(card);
            });

            container.innerHTML = '';
            container.appendChild(grid);
        }

        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.onclick = () => viewProductDetail(product.id);

            const commodityEmojis = {
                'padi': 'üåæ',
                'jagung': 'üåΩ',
                'cabe_merah_keriting': 'üå∂Ô∏è',
                'cabe_merah_besar': 'üå∂Ô∏è',
                'cabe_rawit_hijau': 'üå∂Ô∏è',
                'cabe_rawit_merah': 'üå∂Ô∏è',
                'cabe_hijau_besar': 'üå∂Ô∏è',
                'cabe_keriting_hijau': 'üå∂Ô∏è',
                'tomat': 'üçÖ',
                'kentang': 'ü•î',
                'bawang': 'üßÖ',
                'kedelai': 'ü´ò',
                'kacang': 'ü•ú'
            };

            const emoji = commodityEmojis[product.commodity] || 'üå±';

            const qualityBadge = product.quality_grade === 'A' ? 'badge-quality-a' :
                product.quality_grade === 'B' ? 'badge-quality-b' : 'badge-quality-c';

            card.innerHTML = `
                <div class="product-image">${emoji}</div>
                <div class="product-info">
                    <div class="product-badges">
                        <span class="badge ${qualityBadge}">Grade ${product.quality_grade}</span>
                        ${product.is_preorder ? '<span class="badge badge-preorder">Pre-Order</span>' : ''}
                    </div>
                    <div class="product-title">${product.commodity.charAt(0).toUpperCase() + product.commodity.slice(1)}</div>
                    <div class="product-price">Rp ${product.price_per_kg.toLocaleString('id-ID')}/kg</div>
                    <div class="product-quantity">üì¶ ${product.quantity_kg} kg tersedia</div>
                    <div class="product-location">üìç ${product.location.address || 'Lokasi tidak tersedia'}</div>
                    <div class="product-seller">üë§ ${product.seller_name}</div>
                    <div class="product-actions">
                        <button class="btn btn-primary btn-small" onclick="event.stopPropagation(); contactSeller('${product.seller_phone}', '${product.commodity}')">
                            <i class="fas fa-comment"></i> Hubungi
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); viewProductDetail('${product.id}')">
                            <i class="fas fa-eye"></i> Detail
                        </button>
                    </div>
                </div>
            `;

            return card;
        }

        // ========== FILTERS ==========

        function applyFilters() {
            const commodity = document.getElementById('filter-commodity').value;
            const quality = document.getElementById('filter-quality').value;
            const minPrice = parseFloat(document.getElementById('filter-min-price').value) || 0;
            const maxPrice = parseFloat(document.getElementById('filter-max-price').value) || Infinity;
            const preorderOnly = document.getElementById('filter-preorder').checked;

            let filtered = allProducts.filter(product => {
                if (commodity && product.commodity !== commodity) return false;
                if (quality && product.quality_grade !== quality) return false;
                if (product.price_per_kg < minPrice || product.price_per_kg > maxPrice) return false;
                if (preorderOnly && !product.is_preorder) return false;
                return true;
            });

            displayProducts(filtered);
        }

        function resetFilters() {
            document.getElementById('filter-commodity').value = '';
            document.getElementById('filter-quality').value = '';
            document.getElementById('filter-min-price').value = '';
            document.getElementById('filter-max-price').value = '';
            document.getElementById('filter-preorder').checked = false;
            displayProducts(allProducts);
        }

        // ========== ADD PRODUCT ==========

        function showAddProductModal() {
            document.getElementById('add-product-modal').classList.add('active');
        }

        async function getPriceRecommendation() {
            const commodity = document.getElementById('commodity').value;
            const quality = document.getElementById('quality-grade').value;
            const box = document.getElementById('price-recommendation-box');

            if (!commodity || !quality) {
                box.innerHTML = '';
                return;
            }

            try {
                const response = await fetch(`/api/agrishop/price-recommendation?commodity=${commodity}&quality_grade=${quality}`);
                const result = await response.json();

                if (result.success) {
                    box.innerHTML = `
                        <div class="price-recommendation">
                            <h4><i class="fas fa-lightbulb"></i> Rekomendasi Harga Cerdas</h4>
                            <div class="price-info">
                                <span>Harga Pasar:</span>
                                <span>Rp ${result.market_price.toLocaleString('id-ID')}/kg</span>
                            </div>
                            <div class="price-info">
                                <span>Rekomendasi untuk Grade ${quality}:</span>
                                <strong>Rp ${result.recommended_price.toLocaleString('id-ID')}/kg</strong>
                            </div>
                            <div class="price-info">
                                <span>Rentang Harga:</span>
                                <span>Rp ${result.min_price.toLocaleString('id-ID')} - ${result.max_price.toLocaleString('id-ID')}</span>
                            </div>
                            <div class="price-info">
                                <span>Penyesuaian Kualitas:</span>
                                <span>${result.quality_adjustment}</span>
                            </div>
                        </div>
                    `;

                    // Auto-fill recommended price
                    document.getElementById('price-per-kg').value = result.recommended_price;
                }
            } catch (error) {
                console.error('Error getting price recommendation:', error);
            }
        }

        async function submitProduct(event) {
            event.preventDefault();

            const submitBtn = event.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menambahkan...';

            const productData = {
                seller_name: document.getElementById('seller-name').value,
                seller_phone: document.getElementById('seller-phone').value,
                commodity: document.getElementById('commodity').value,
                quantity_kg: parseFloat(document.getElementById('quantity-kg').value),
                price_per_kg: parseFloat(document.getElementById('price-per-kg').value),
                quality_grade: document.getElementById('quality-grade').value,
                address: document.getElementById('address').value,
                latitude: parseFloat(document.getElementById('latitude').value) || 0,
                longitude: parseFloat(document.getElementById('longitude').value) || 0,
                harvest_date: document.getElementById('harvest-date').value,
                description: document.getElementById('description').value,
                is_preorder: document.getElementById('is-preorder').checked
            };

            try {
                const response = await fetch('/api/agrishop/products', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(productData)
                });

                const result = await response.json();

                if (result.success) {
                    showToast('success', 'Produk berhasil ditambahkan!');
                    closeModal('add-product-modal');
                    document.getElementById('add-product-form').reset();
                    document.getElementById('price-recommendation-box').innerHTML = '';

                    // Save seller info
                    saveSellerInfo(productData.seller_name, productData.seller_phone);

                    // Reload products
                    await loadProducts();
                } else {
                    showToast('error', result.error || 'Gagal menambahkan produk');
                }
            } catch (error) {
                console.error('Error adding product:', error);
                showToast('error', 'Terjadi kesalahan saat menambahkan produk');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-check"></i> Tambahkan Produk';
            }
        }

        // ========== PRODUCT DETAIL ==========

        async function viewProductDetail(productId) {
            try {
                const response = await fetch(`/api/agrishop/products/${productId}`);
                const result = await response.json();

                if (result.success) {
                    currentProduct = result.data;
                    displayProductDetail(currentProduct);
                    document.getElementById('product-detail-modal').classList.add('active');
                } else {
                    showToast('error', 'Gagal memuat detail produk');
                }
            } catch (error) {
                console.error('Error loading product detail:', error);
                showToast('error', 'Terjadi kesalahan saat memuat detail produk');
            }
        }

        function displayProductDetail(product) {
            const commodityEmojis = {
                'padi': 'üåæ',
                'jagung': 'üåΩ',
                'cabe_merah_keriting': 'üå∂Ô∏è',
                'cabe_merah_besar': 'üå∂Ô∏è',
                'cabe_rawit_hijau': 'üå∂Ô∏è',
                'cabe_rawit_merah': 'üå∂Ô∏è',
                'cabe_hijau_besar': 'üå∂Ô∏è',
                'cabe_keriting_hijau': 'üå∂Ô∏è',
                'tomat': 'üçÖ',
                'kentang': 'ü•î',
                'bawang': 'üßÖ',
                'kedelai': 'ü´ò',
                'kacang': 'ü•ú'
            };

            const emoji = commodityEmojis[product.commodity] || 'üå±';
            const qualityBadge = product.quality_grade === 'A' ? 'badge-quality-a' :
                product.quality_grade === 'B' ? 'badge-quality-b' : 'badge-quality-c';

            let content = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 6rem; margin-bottom: 15px;">${emoji}</div>
                    <h3 style="color: #2d3748; font-size: 2rem; margin-bottom: 10px;">
                        ${product.commodity.charAt(0).toUpperCase() + product.commodity.slice(1)}
                    </h3>
                    <div style="display: flex; gap: 8px; justify-content: center; margin-bottom: 15px;">
                        <span class="badge ${qualityBadge}">Grade ${product.quality_grade}</span>
                        ${product.is_preorder ? '<span class="badge badge-preorder">Pre-Order (Diskon 5%)</span>' : ''}
                    </div>
                </div>

                <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <strong style="color: #4a5568;">Harga per kg:</strong>
                            <div style="color: #667eea; font-size: 1.8rem; font-weight: 800;">
                                Rp ${product.price_per_kg.toLocaleString('id-ID')}
                            </div>
                        </div>
                        <div>
                            <strong style="color: #4a5568;">Jumlah Tersedia:</strong>
                            <div style="color: #2d3748; font-size: 1.5rem; font-weight: 700;">
                                ${product.quantity_kg} kg
                            </div>
                        </div>
                    </div>
                    <div style="color: #4a5568; font-size: 1.1rem;">
                        <strong>Total Nilai:</strong> Rp ${product.total_price.toLocaleString('id-ID')}
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4 style="color: #2d3748; margin-bottom: 10px;"><i class="fas fa-user"></i> Informasi Penjual</h4>
                    <div style="color: #4a5568;">
                        <p><strong>Nama:</strong> ${product.seller_name}</p>
                        <p><strong>Lokasi:</strong> ${product.location.address || 'Tidak tersedia'}</p>
                        ${product.harvest_date ? `<p><strong>Tanggal Panen:</strong> ${product.harvest_date}</p>` : ''}
                    </div>
                </div>

                ${product.description ? `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #2d3748; margin-bottom: 10px;"><i class="fas fa-info-circle"></i> Deskripsi</h4>
                        <p style="color: #4a5568;">${product.description}</p>
                    </div>
                ` : ''}

                <div style="margin-bottom: 20px;">
                    <h4 style="color: #2d3748; margin-bottom: 10px;"><i class="fas fa-chart-bar"></i> Statistik</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; color: #4a5568;">
                        <div>üëÅÔ∏è ${product.views || 0} views</div>
                        <div>‚ù§Ô∏è ${product.interests || 0} interests</div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button class="btn btn-primary" style="flex: 1;" onclick="contactSeller('${product.seller_phone}', '${product.commodity}')">
                        <i class="fas fa-comment"></i> Hubungi Penjual
                    </button>
                    <button class="btn btn-secondary" onclick="markInterest('${product.id}')">
                        <i class="fas fa-heart"></i> Tertarik
                    </button>
                </div>
            `;

            if (product.is_preorder) {
                content += `
                    <div style="margin-top: 25px; padding-top: 25px; border-top: 2px solid #e2e8f0;">
                        <h4 style="color: #2d3748; margin-bottom: 15px;"><i class="fas fa-shopping-cart"></i> Pre-Order Sekarang</h4>
                        <form onsubmit="submitPreOrder(event, '${product.id}')">
                            <div class="form-group">
                                <label>Nama Pembeli</label>
                                <input type="text" id="buyer-name" required>
                            </div>
                            <div class="form-group">
                                <label>Nomor WhatsApp</label>
                                <input type="tel" id="buyer-phone" placeholder="08xxxxxxxxxx" required>
                            </div>
                            <div class="form-group">
                                <label>Jumlah (kg)</label>
                                <input type="number" id="preorder-quantity" step="0.1" min="0.1" max="${product.quantity_kg}" required>
                            </div>
                            <div class="form-group">
                                <label>Catatan (opsional)</label>
                                <textarea id="preorder-notes" placeholder="Catatan tambahan..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-success" style="width: 100%;">
                                <i class="fas fa-check"></i> Buat Pre-Order
                            </button>
                        </form>
                    </div>
                `;
            }

            document.getElementById('product-detail-content').innerHTML = content;
        }

        async function markInterest(productId) {
            try {
                const response = await fetch(`/api/agrishop/products/${productId}/interest`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showToast('success', 'Terima kasih atas minat Anda!');
                    // Refresh product detail
                    await viewProductDetail(productId);
                } else {
                    showToast('error', 'Gagal menandai minat');
                }
            } catch (error) {
                console.error('Error marking interest:', error);
                showToast('error', 'Terjadi kesalahan');
            }
        }

        async function submitPreOrder(event, productId) {
            event.preventDefault();

            const submitBtn = event.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';

            const preorderData = {
                product_id: productId,
                buyer_name: document.getElementById('buyer-name').value,
                buyer_phone: document.getElementById('buyer-phone').value,
                quantity_kg: parseFloat(document.getElementById('preorder-quantity').value),
                notes: document.getElementById('preorder-notes').value
            };

            try {
                const response = await fetch('/api/agrishop/preorders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(preorderData)
                });

                const result = await response.json();

                if (result.success) {
                    const calc = result.data.calculation;
                    showToast('success', `Pre-order berhasil! Total: Rp ${calc.total.toLocaleString('id-ID')}`);
                    closeModal('product-detail-modal');

                    // Contact seller via WhatsApp
                    const message = `Halo, saya telah membuat pre-order untuk ${preorderData.quantity_kg} kg ${currentProduct.commodity}. Total: Rp ${calc.total.toLocaleString('id-ID')}`;
                    contactSeller(currentProduct.seller_phone, currentProduct.commodity, message);
                } else {
                    showToast('error', result.error || 'Gagal membuat pre-order');
                }
            } catch (error) {
                console.error('Error submitting pre-order:', error);
                showToast('error', 'Terjadi kesalahan saat membuat pre-order');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-check"></i> Buat Pre-Order';
            }
        }

        // ========== SELLER DASHBOARD ==========

        function showSellerDashboard() {
            document.getElementById('seller-dashboard-modal').classList.add('active');

            // Auto-load if phone is saved
            const savedPhone = localStorage.getItem('agrishop_seller_phone');
            if (savedPhone) {
                document.getElementById('dashboard-phone').value = savedPhone;
                loadSellerDashboard();
            }
        }

        async function loadSellerDashboard() {
            const phone = document.getElementById('dashboard-phone').value;

            if (!phone) {
                showToast('error', 'Masukkan nomor WhatsApp Anda');
                return;
            }

            const dashboardData = document.getElementById('dashboard-data');
            dashboardData.innerHTML = '<div class="loading"><div class="spinner"></div>Memuat data...</div>';

            try {
                const response = await fetch(`/api/agrishop/my-products?seller_phone=${phone}`);
                const result = await response.json();

                if (result.success) {
                    displaySellerDashboard(result.data, result.statistics);
                    localStorage.setItem('agrishop_seller_phone', phone);
                } else {
                    dashboardData.innerHTML = '<div class="empty-state"><p>Gagal memuat data</p></div>';
                }
            } catch (error) {
                console.error('Error loading seller dashboard:', error);
                dashboardData.innerHTML = '<div class="empty-state"><p>Terjadi kesalahan</p></div>';
            }
        }

        function displaySellerDashboard(products, stats) {
            const dashboardData = document.getElementById('dashboard-data');

            let content = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 25px 0;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px;">
                        <div style="font-size: 2rem; font-weight: 800;">${stats.total_products}</div>
                        <div>Total Produk</div>
                    </div>
                    <div style="background: #48bb78; color: white; padding: 20px; border-radius: 10px;">
                        <div style="font-size: 2rem; font-weight: 800;">${stats.available_products}</div>
                        <div>Tersedia</div>
                    </div>
                    <div style="background: #4299e1; color: white; padding: 20px; border-radius: 10px;">
                        <div style="font-size: 2rem; font-weight: 800;">${stats.total_views}</div>
                        <div>Total Views</div>
                    </div>
                    <div style="background: #ed8936; color: white; padding: 20px; border-radius: 10px;">
                        <div style="font-size: 2rem; font-weight: 800;">Rp ${Math.round(stats.total_value / 1000)}K</div>
                        <div>Total Nilai</div>
                    </div>
                </div>

                <h4 style="color: #2d3748; margin: 25px 0 15px;">Produk Saya</h4>
            `;

            if (products.length === 0) {
                content += '<div class="empty-state"><p>Anda belum memiliki produk</p></div>';
            } else {
                content += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';
                content += `
                    <thead>
                        <tr style="background: #f7fafc; text-align: left;">
                            <th style="padding: 12px; border-bottom: 2px solid #e2e8f0;">Komoditas</th>
                            <th style="padding: 12px; border-bottom: 2px solid #e2e8f0;">Jumlah</th>
                            <th style="padding: 12px; border-bottom: 2px solid #e2e8f0;">Harga/kg</th>
                            <th style="padding: 12px; border-bottom: 2px solid #e2e8f0;">Status</th>
                            <th style="padding: 12px; border-bottom: 2px solid #e2e8f0;">Views</th>
                            <th style="padding: 12px; border-bottom: 2px solid #e2e8f0;">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                `;

                products.forEach(product => {
                    const statusColor = product.status === 'available' ? '#48bb78' : '#cbd5e0';
                    content += `
                        <tr style="border-bottom: 1px solid #e2e8f0;">
                            <td style="padding: 12px;">${product.commodity}</td>
                            <td style="padding: 12px;">${product.quantity_kg} kg</td>
                            <td style="padding: 12px;">Rp ${product.price_per_kg.toLocaleString('id-ID')}</td>
                            <td style="padding: 12px;">
                                <span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 5px; font-size: 0.8rem;">
                                    ${product.status}
                                </span>
                            </td>
                            <td style="padding: 12px;">${product.views || 0}</td>
                            <td style="padding: 12px;">
                                <button class="btn btn-danger btn-small" onclick="deleteProduct('${product.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                content += '</tbody></table></div>';
            }

            dashboardData.innerHTML = content;
        }

        async function deleteProduct(productId) {
            if (!confirm('Yakin ingin menghapus produk ini?')) {
                return;
            }

            try {
                const response = await fetch(`/api/agrishop/products/${productId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showToast('success', 'Produk berhasil dihapus');
                    loadSellerDashboard();
                    loadProducts();
                } else {
                    showToast('error', 'Gagal menghapus produk');
                }
            } catch (error) {
                console.error('Error deleting product:', error);
                showToast('error', 'Terjadi kesalahan');
            }
        }

        // ========== UTILITIES ==========

        function contactSeller(phone, commodity, customMessage = null) {
            const message = customMessage || `Halo, saya tertarik dengan produk ${commodity} Anda di AgriShop`;
            const whatsappUrl = `https://wa.me/${phone.replace(/^0/, '62')}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showToast(type, message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                info: '‚ÑπÔ∏è'
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type]}</div>
                <div class="toast-message">${message}</div>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 4000);
        }

        function showError(message) {
            const container = document.getElementById('products-container');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">‚ö†Ô∏è</div>
                    <h3>Terjadi Kesalahan</h3>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="loadProducts()">
                        <i class="fas fa-redo"></i> Coba Lagi
                    </button>
                </div>
            `;
        }

        function saveSellerInfo(name, phone) {
            localStorage.setItem('agrishop_seller_name', name);
            localStorage.setItem('agrishop_seller_phone', phone);
        }

        function loadSellerInfoFromStorage() {
            const savedName = localStorage.getItem('agrishop_seller_name');
            const savedPhone = localStorage.getItem('agrishop_seller_phone');

            if (savedName) document.getElementById('seller-name').value = savedName;
            if (savedPhone) document.getElementById('seller-phone').value = savedPhone;
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }
    </script>
</body>

</html>