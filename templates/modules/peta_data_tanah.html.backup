<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó∫Ô∏è AgriMap - Peta Pertanian Cerdas</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet.draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <!-- Leaflet.heat CSS (for heatmap) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f0fdf4;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        #map {
            flex: 1;
            height: 100vh;
        }

        .sidebar {
            width: 400px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 1.5rem;
            color: #059669;
            margin-bottom: 10px;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #059669;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.9rem;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

        .tab.active {
            color: #059669;
            border-bottom-color: #059669;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            font-weight: 500;
            color: #374151;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        button {
            width: 100%;
            padding: 12px;
            background: #059669;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        button:hover {
            background: #047857;
        }

        button.secondary {
            background: #3b82f6;
        }

        button.secondary:hover {
            background: #2563eb;
        }

        .weather-card {
            background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .weather-card h3 {
            font-size: 1.1rem;
            margin-bottom: 15px;
        }

        .weather-current {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .temp-big {
            font-size: 2.5rem;
            font-weight: 700;
        }

        .weather-details {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .weather-details div {
            margin: 5px 0;
        }

        .npk-card {
            background: #f0fdf4;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #10b981;
        }

        .npk-values {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .npk-value {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }

        .npk-value .label {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .npk-value .value {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 5px 0;
        }

        .npk-value .status {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .status-optimal {
            background: #d1fae5;
            color: #065f46;
        }

        .status-low {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-high {
            background: #fef3c7;
            color: #92400e;
        }

        .area-display {
            background: #ecfdf5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #10b981;
        }

        .area-display h3 {
            color: #059669;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .area-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #047857;
        }

        .recommendations {
            background: #f0fdf4;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .recommendations h3 {
            color: #059669;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .recommendations ul {
            list-style: none;
            padding: 0;
        }

        .recommendations li {
            padding: 8px 0;
            border-bottom: 1px solid #d1fae5;
            font-size: 0.9rem;
            color: #065f46;
        }

        .recommendations li:last-child {
            border-bottom: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }

        .instructions {
            background: #eff6ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.85rem;
            color: #1e40af;
        }

        .instructions h4 {
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .instructions ol {
            margin-left: 20px;
        }

        .instructions li {
            margin: 5px 0;
        }

        .layer-control {
            background: white;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 1px solid #e5e7eb;
        }

        .layer-control label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: normal;
        }

        .layer-control input[type="checkbox"] {
            width: auto;
        }

        .saved-polygons {
            max-height: 200px;
            overflow-y: auto;
        }

        .polygon-item {
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .polygon-item:hover {
            background: #f3f4f6;
        }

        .polygon-item .name {
            font-weight: 600;
            color: #111827;
        }

        .polygon-item .area {
            font-size: 0.85rem;
            color: #6b7280;
        }
    </style>
</head>

<body>
    <div class="container">
        <div id="map"></div>

        <div class="sidebar">
            <a href="/dashboard" class="back-link">‚Üê Kembali ke Dashboard</a>
            <h1>üó∫Ô∏è AgriMap - Peta Pertanian Cerdas</h1>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('overview')">üìä Overview</button>
                <button class="tab" onclick="switchTab('npk')">üß™ Data NPK</button>
                <button class="tab" onclick="switchTab('layers')">üó∫Ô∏è Layer</button>
            </div>

            <!-- Overview Tab -->
            <div id="overview-tab" class="tab-content active">
                <!-- Instructions -->
                <div class="instructions">
                    <h4>üìê Cara Menggunakan:</h4>
                    <ol>
                        <li>Gambar polygon untuk menandai lahan</li>
                        <li>Tambahkan data NPK tanah</li>
                        <li>Lihat rekomendasi pertanian</li>
                        <li>Integrasikan dengan kalkulator pupuk</li>
                    </ol>
                </div>

                <!-- Area Display -->
                <div id="area-display" class="area-display" style="display:none;">
                    <h3>üìè Luas Lahan</h3>
                    <div class="area-value" id="area-value">-</div>
                    <div style="font-size:0.9rem; color:#065f46; margin-top:5px;" id="area-hectares">-</div>

                    <button id="btn-save-polygon" class="secondary" style="margin-top:15px;">üíæ Simpan Lahan</button>
                    <button id="btn-fertilizer-calc" style="margin-top:5px;">üßÆ Hitung Pupuk</button>
                </div>

                <!-- Weather Widget -->
                <div id="weather-widget" class="loading">
                    Memuat data cuaca...
                </div>

                <!-- Recommendations -->
                <div id="recommendations-widget" style="display:none;" class="recommendations">
                    <h3>üí° Rekomendasi Pertanian</h3>
                    <ul id="recommendations-list"></ul>
                </div>

                <!-- Saved Polygons -->
                <div id="saved-polygons-section" style="margin-top:20px;">
                    <h3 style="font-size:1rem; color:#059669; margin-bottom:10px;">üìç Lahan Tersimpan</h3>
                    <div id="saved-polygons-list" class="saved-polygons"></div>
                </div>
            </div>

            <!-- NPK Data Tab -->
            <div id="npk-tab" class="tab-content">
                <h3 style="font-size:1rem; color:#059669; margin-bottom:15px;">üß™ Input Data NPK Tanah</h3>

                <form id="npk-form">
                    <div class="form-group">
                        <label>Nitrogen (N)</label>
                        <input type="number" id="n-input" step="0.1" required placeholder="Contoh: 45">
                    </div>
                    <div class="form-group">
                        <label>Fosfor (P)</label>
                        <input type="number" id="p-input" step="0.1" required placeholder="Contoh: 30">
                    </div>
                    <div class="form-group">
                        <label>Kalium (K)</label>
                        <input type="number" id="k-input" step="0.1" required placeholder="Contoh: 40">
                    </div>
                    <div class="form-group">
                        <label>Catatan (Opsional)</label>
                        <textarea id="npk-notes" rows="2" placeholder="Lokasi sampling, dll"></textarea>
                    </div>
                    <button type="submit">üíæ Simpan Data NPK</button>
                </form>

                <!-- NPK Analysis Result -->
                <div id="npk-analysis" style="display:none; margin-top:20px;">
                    <h3 style="font-size:1rem; color:#059669; margin-bottom:10px;">üìä Analisis NPK</h3>
                    <div id="npk-analysis-content"></div>
                </div>

                <!-- Existing NPK Data -->
                <div id="existing-npk" style="margin-top:20px;">
                    <h3 style="font-size:1rem; color:#059669; margin-bottom:10px;">üìã Data NPK Tersimpan</h3>
                    <div id="npk-data-list"></div>
                </div>
            </div>

            <!-- Layers Tab -->
            <div id="layers-tab" class="tab-content">
                <h3 style="font-size:1rem; color:#059669; margin-bottom:15px;">üó∫Ô∏è Kontrol Layer</h3>

                <div class="layer-control">
                    <label>
                        <input type="checkbox" id="layer-npk-heatmap">
                        üî• NPK Heatmap
                    </label>
                    <label>
                        <input type="checkbox" id="layer-npk-markers" checked>
                        üìç Marker NPK
                    </label>
                    <label>
                        <input type="checkbox" id="layer-weather" checked>
                        üå§Ô∏è Data Cuaca
                    </label>
                </div>

                <button id="btn-refresh-layers">üîÑ Refresh Layers</button>

                <div style="margin-top:20px;">
                    <h4 style="font-size:0.9rem; color:#374151; margin-bottom:10px;">üìä Statistik</h4>
                    <div id="statistics-display"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet.draw JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <!-- Turf.js for area calculation -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <!-- Leaflet.heat for heatmap -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <script>
        // Global variables
        let currentPolygon = null;
        let currentPolygonData = null;
        let currentLocation = null;
        let npkMarkers = [];
        let heatmapLayer = null;

        // Initialize map (centered on Indonesia)
        const map = L.map('map').setView([-2.5, 118], 5);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);

        // Layer for drawn items
        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        // Drawing controls
        const drawControl = new L.Control.Draw({
            draw: {
                polygon: {
                    allowIntersection: false,
                    shapeOptions: {
                        color: '#10b981',
                        weight: 3
                    }
                },
                rectangle: {
                    shapeOptions: {
                        color: '#3b82f6',
                        weight: 3
                    }
                },
                marker: true,
                polyline: false,
                circle: false,
                circlemarker: false
            },
            edit: {
                featureGroup: drawnItems,
                remove: true
            }
        });
        map.addControl(drawControl);

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // Handle polygon creation
        map.on('draw:created', function (e) {
            const layer = e.layer;

            if (e.layerType === 'polygon' || e.layerType === 'rectangle') {
                drawnItems.addLayer(layer);
                currentPolygon = layer;

                // Calculate area using Turf.js
                const geojson = layer.toGeoJSON();
                const area = turf.area(geojson);
                const areaSqm = area.toFixed(2);
                const areaHa = (area / 10000).toFixed(4);

                currentPolygonData = {
                    coordinates: geojson.geometry.coordinates,
                    area_sqm: parseFloat(areaSqm),
                    area_hectares: parseFloat(areaHa)
                };

                // Display area
                document.getElementById('area-display').style.display = 'block';
                document.getElementById('area-value').textContent = `${Number(areaSqm).toLocaleString('id-ID')} m¬≤`;
                document.getElementById('area-hectares').textContent = `${areaHa} hektar`;

                // Add popup to polygon
                layer.bindPopup(`
                    <b>Luas Lahan:</b><br>
                    ${Number(areaSqm).toLocaleString('id-ID')} m¬≤<br>
                    ${areaHa} hektar
                `).openPopup();

                // Get center of polygon for weather
                const center = turf.center(geojson);
                const [lon, lat] = center.geometry.coordinates;
                currentLocation = { lat, lon };
                loadWeather(lat, lon);
            } else if (e.layerType === 'marker') {
                // Handle marker for NPK sampling
                drawnItems.addLayer(layer);
                const latlng = layer.getLatLng();
                currentLocation = { lat: latlng.lat, lon: latlng.lng };

                // Switch to NPK tab
                switchTab('npk');
                document.querySelectorAll('.tab')[1].click();
            }
        });

        // Save polygon
        document.getElementById('btn-save-polygon').addEventListener('click', async function () {
            if (!currentPolygonData) {
                alert('Tidak ada polygon yang digambar!');
                return;
            }

            const name = prompt('Nama lahan:', 'Lahan ' + new Date().toLocaleDateString('id-ID'));
            if (!name) return;

            try {
                const response = await fetch('/api/agrimap/polygon', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        coordinates: currentPolygonData.coordinates,
                        area_sqm: currentPolygonData.area_sqm
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('‚úÖ Lahan berhasil disimpan!');
                    currentPolygon.polygonId = data.data.id;
                    loadSavedPolygons();
                } else {
                    alert('‚ùå Gagal menyimpan: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Terjadi kesalahan');
            }
        });

        // Fertilizer calculator integration
        document.getElementById('btn-fertilizer-calc').addEventListener('click', function () {
            if (!currentPolygonData) {
                alert('Tidak ada data lahan!');
                return;
            }

            // Redirect to fertilizer calculator with area parameter
            const area = currentPolygonData.area_sqm;
            window.location.href = `/modules/kalkulator-pupuk-holistik?area=${area}`;
        });

        // NPK Form submission
        document.getElementById('npk-form').addEventListener('submit', async function (e) {
            e.preventDefault();

            if (!currentLocation) {
                alert('Klik pada peta untuk menentukan lokasi sampling!');
                return;
            }

            const nValue = parseFloat(document.getElementById('n-input').value);
            const pValue = parseFloat(document.getElementById('p-input').value);
            const kValue = parseFloat(document.getElementById('k-input').value);
            const notes = document.getElementById('npk-notes').value;

            try {
                const response = await fetch('/api/agrimap/npk-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        latitude: currentLocation.lat,
                        longitude: currentLocation.lon,
                        n_value: nValue,
                        p_value: pValue,
                        k_value: kValue,
                        polygon_id: currentPolygon?.polygonId,
                        notes: notes
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('‚úÖ Data NPK berhasil disimpan!');

                    // Display analysis
                    displayNPKAnalysis(data.analysis);

                    // Add marker to map
                    const marker = L.marker([currentLocation.lat, currentLocation.lon], {
                        icon: L.divIcon({
                            className: 'npk-marker',
                            html: 'üß™',
                            iconSize: [30, 30]
                        })
                    }).addTo(map);

                    marker.bindPopup(`
                        <b>Data NPK</b><br>
                        N: ${nValue}<br>
                        P: ${pValue}<br>
                        K: ${kValue}
                    `);

                    npkMarkers.push(marker);

                    // Reset form
                    document.getElementById('npk-form').reset();
                    loadNPKData();
                } else {
                    alert('‚ùå Gagal menyimpan: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Terjadi kesalahan');
            }
        });

        // Display NPK Analysis
        function displayNPKAnalysis(analysis) {
            const analysisDiv = document.getElementById('npk-analysis');
            const contentDiv = document.getElementById('npk-analysis-content');

            let html = '<div class="npk-values">';

            for (const [nutrient, data] of Object.entries(analysis.analysis)) {
                const statusClass = data.status === 'Optimal' ? 'status-optimal' :
                    data.status === 'Rendah' ? 'status-low' : 'status-high';

                html += `
                    <div class="npk-value">
                        <div class="label">${nutrient}</div>
                        <div class="value" style="color:${data.color}">${data.value}</div>
                        <div class="status ${statusClass}">${data.status}</div>
                    </div>
                `;
            }

            html += '</div>';
            html += `<p style="margin-top:15px; font-size:0.9rem; color:#374151;">${analysis.overall.recommendation}</p>`;

            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            map.setView([lat, lon], 13);
            loadWeather(lat, lon);
        },
        function (error) {
            loadWeather(-6.2088, 106.8456);
        }
            );
        } else {
            loadWeather(-6.2088, 106.8456);
        }

        // Load initial data
        loadSavedPolygons();
        loadNPKData();
        loadStatistics();
    </script>
</body>

</html>