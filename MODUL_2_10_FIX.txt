INSTRUKSI PERBAIKAN MODUL 2 DAN MODUL 10
==========================================

File: templates/modules/dasbor_rekomendasi_terpadu.html

MASALAH:
--------
- Line 422-424: Modul 2 dideklarasikan (formRec, resultRecDiv)
- Line 425: Langsung cek `if (histPriceForm)` yang adalah Modul 11!
- Modul 2 tidak punya event listener sama sekali
- Modul 10 juga hilang

SOLUSI:
-------
Ganti line 425-479 dengan kode berikut:

```javascript
                if (formRec) {
                    formRec.addEventListener('submit', async (event) => {
                        event.preventDefault();
                        console.log('üìù Modul 2: Recommendation: Form submitted!');
                        resultRecDiv.innerHTML = '<p>Menghitung rekomendasi...</p>';
                        const requestData = {
                            ph_tanah: formRec.querySelector('#ph-input').value,
                            skor_bwd: bwdInput ? bwdInput.value : 0,
                            kelembaban_tanah: formRec.querySelector('#moisture-input').value,
                            umur_tanaman_hari: formRec.querySelector('#age-input').value,
                        };
                        try {
                            const response = await fetch(`${baseUrl}${apiPrefix}/recommendation`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(requestData)
                            });
                            const data = await response.json();
                            if (data.success) {
                                resultRecDiv.innerHTML = `<h3>Rekomendasi Pupuk</h3><p>${data.recommendation}</p>`;
                            } else {
                                resultRecDiv.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
                            }
                        } catch (error) {
                            console.error("Error:", error);
                            resultRecDiv.innerHTML = `<p style="color: red;">Gagal terhubung.</p>`;
                        }
                    });
                }

                // --- Logika untuk Modul 10 (Strategi Penyemprotan) ---
                const sprayForm = document.getElementById('spraying-strategy-form'),
                    resultSpray = document.getElementById('result-spraying');
                if (sprayForm) {
                    sprayForm.addEventListener('submit', async (event) => {
                        event.preventDefault();
                        resultSpray.innerHTML = '<p>Menyusun rencana...</p>';
                        try {
                            const response = await fetch(`${baseUrl}${apiPrefix}/get-spraying-recommendation`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    pest: sprayForm.querySelector('#pest-select').value
                                })
                            });
                            const data = await response.json();
                            if (data.success) {
                                const d = data.data;
                                let html = `<h3>${d.strategy.name}</h3><p>${d.strategy.description}</p>`;
                                d.strategy.cycles.forEach(c => {
                                    html += `<div class="strategy-cycle"><h4>${c.weeks}: ${c.level}</h4><p><strong>Bahan Aktif:</strong> ${c.active_ingredient}<br><strong>Grup IRAC:</strong> ${c.irac_code}<br><strong>SOP:</strong> ${c.sop}</p></div>`;
                                });
                                html += `<h3>${d.protocol.title}</h3><ul>`;
                                d.protocol.steps.forEach(s => {
                                    html += `<li>${s}</li>`;
                                });
                                html += '</ul>';
                                resultSpray.innerHTML = html;
                            } else {
                                resultSpray.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
                            }
                        } catch (error) {
                            console.error("Error:", error);
                            resultSpray.innerHTML = `<p style="color: red;">Gagal terhubung.</p>`;
                        }
                    });
                }

                // --- Logika untuk Modul 11 (Grafik Harga) ---
                const histPriceForm = document.getElementById('historical-price-form'),
                    resultHistPrice = document.getElementById('result-historical-price');
                let priceChart;
                if (histPriceForm) {
                    const chartCanvas = document.getElementById('price-chart').getContext('2d');
                    histPriceForm.addEventListener('submit', async (event) => {
                        event.preventDefault();
                        resultHistPrice.querySelector('p').textContent = 'Memvisualisasikan data...';
                        const requestData = {
                            commodity: histPriceForm.querySelector('#historical-commodity-select').value,
                            range: histPriceForm.querySelector('#time-range-select').value
                        };
                        try {
                            const response = await fetch(`${baseUrl}${apiPrefix}/get-historical-prices`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(requestData)
                            });
                            const data = await response.json();
                            if (data.success) {
                                resultHistPrice.querySelector('p').textContent = `Grafik tren harga:`;
                                if (priceChart) priceChart.destroy();
                                priceChart = new Chart(chartCanvas, {
                                    type: 'line',
                                    data: {
                                        labels: data.labels,
                                        datasets: [{
                                            label: 'Harga (Rp)',
                                            data: data.prices,
                                            borderColor: 'rgba(46, 125, 50, 1)',
                                            backgroundColor: 'rgba(76, 175, 80, 0.2)',
                                            borderWidth: 2,
                                            fill: true,
                                            tension: 0.3
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        scales: {
                                            y: {
                                                ticks: {
                                                    callback: (v) => formatRupiah(v)
                                                }
                                            }
                                        }
                                    }
                                });
                            } else {
                                resultHistPrice.querySelector('p').textContent = `Error: ${data.error}`;
                            }
                        } catch (error) {
                            console.error("Error:", error);
                            resultHistPrice.querySelector('p').textContent = 'Error: Gagal terhubung.';
                        }
                    });
                }
```

CARA MANUAL FIX:
----------------
1. Buka file: templates/modules/dasbor_rekomendasi_terpadu.html
2. Cari line 425: `if (histPriceForm) {`
3. Hapus dari line 425 sampai line 479 (termasuk closing brace `}`)
4. Paste kode di atas (dari `if (formRec) {` sampai akhir Modul 11)
5. Save file
6. Refresh browser

ATAU CARA CEPAT:
----------------
Hanya ganti line 425:
- DARI: `if (histPriceForm) {`
- JADI: `if (formRec) {`

Lalu ganti line 427:
- DARI: `histPriceForm.addEventListener('submit', async (event) => {`
- JADI: `formRec.addEventListener('submit', async (event) => {`

Lalu ganti line 429-432 dengan:
```javascript
                        resultRecDiv.innerHTML = '<p>Menghitung rekomendasi...</p>';
                        const requestData = {
                            ph_tanah: formRec.querySelector('#ph-input').value,
                            skor_bwd: bwdInput ? bwdInput.value : 0,
                            kelembaban_tanah: formRec.querySelector('#moisture-input').value,
                            umur_tanaman_hari: formRec.querySelector('#age-input').value,
                        };
```

Dan ganti line 435:
- DARI: `/get-historical-prices`
- JADI: `/recommendation`

Dan ganti line 443-472 dengan:
```javascript
                            if (data.success) {
                                resultRecDiv.innerHTML = `<h3>Rekomendasi Pupuk</h3><p>${data.recommendation}</p>`;
                            } else {
                                resultRecDiv.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
                            }
                        } catch (error) {
                            console.error("Error:", error);
                            resultRecDiv.innerHTML = `<p style="color: red;">Gagal terhubung.</p>`;
                        }
                    });
                }

                // TAMBAHKAN MODUL 10 DI SINI (lihat kode lengkap di atas)

                // TAMBAHKAN MODUL 11 DI SINI (lihat kode lengkap di atas)
```
